#!/usr/bin/env bash
#!/bin/bash
set -e

echo "üîç Checking user counts BEFORE wipe..."
./scripts/check_all_users.sh
echo

read -p "‚ö†Ô∏è Are you sure you want to DELETE ALL users from Firebase and Postgres? (y/n): " confirm
[[ $confirm == [yY] ]] || exit 1

echo "üî• Deleting all Firebase Auth users..."
python3 scripts/delete_firebase_users.py

echo "üßπ Truncating PostgreSQL users table (cascades to game_stats)..."
psql -U aoe2user -d aoe2db -h localhost -c "TRUNCATE TABLE users RESTART IDENTITY CASCADE;"

# Only try connecting if optional env var is present
if [[ -n "$RENDER_DB_HOST" && -n "$RENDER_DB_USER" && -n "$RENDER_DB_NAME" ]]; then
  PGPASSWORD="$RENDER_DB_PASSWORD" psql -U "$RENDER_DB_USER" -d "$RENDER_DB_NAME" -h "$RENDER_DB_HOST" -c "
    SELECT email, ingame_name, is_verified FROM users ORDER BY created_at DESC LIMIT 20;
  " || echo "‚ùå Could not connect to Render Postgres."
else
  echo "   ‚ö†Ô∏è Skipping Render DB check ‚Äî missing credentials or RENDER_DB_HOST unset."
fi

echo
echo "üîÅ Checking user counts AFTER wipe..."
./scripts/check_all_users.sh

echo
echo "‚úÖ All users deleted from Firebase and Postgres."
