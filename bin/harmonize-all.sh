#!/usr/bin/env bash
set -euo pipefail
shopt -s nullglob

# â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PYSHORT="3.13"
ROOT="$HOME/projects"
PYTHON_BIN="$(command -v python${PYSHORT} || command -v python3 || true)"

if [[ -z "$PYTHON_BIN" || ! -x "$PYTHON_BIN" ]]; then
  echo "âŒ Python $PYSHORT not found. Try: brew install python@$PYSHORT"
  exit 1
fi

echo "ğŸ”¥ Removing all .python-version filesâ€¦"
find "$ROOT" -name '.python-version' -delete

echo "âŒ Uninstalling all pyenv virtualenvs using 3.12â€¦"
pyenv virtualenvs --bare | grep '^.*3\.12.*$' | while read -r venv; do
  echo "  ğŸ§¨ Removing $venv"
  pyenv uninstall -f "$venv"
done

# â”€â”€â”€ HARMONIZE LOOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ” Rewriting all .envrc files and initializing venvsâ€¦"
for dir in "$ROOT"/*/; do
  [[ -d "$dir" ]] || continue
  cd "$dir"

  if [[ -f requirements.txt || -f pyproject.toml || -f setup.py ]]; then
    repo="$(basename "$dir")"
    echo "â–¶ Harmonizing: $repo"

    VENV_DIR=".direnv/python-$PYSHORT"
    ENVRC=".envrc"

    cat > "$ENVRC" <<EOF
# Auto-generated by harmonize-all.sh
export VIRTUAL_ENV="\$PWD/$VENV_DIR"
export PATH="\$VIRTUAL_ENV/bin:\$PATH"
source "\$VIRTUAL_ENV/bin/activate"
export PATH="\$PWD/bin:\$PATH"
EOF

    echo "  âœ… Wrote $ENVRC"
    direnv allow . >/dev/null || echo "âš ï¸  direnv failed for $repo"

    if [[ ! -d "$VENV_DIR" ]]; then
      echo "  ğŸ Creating venv at $VENV_DIR â€¦"
      "$PYTHON_BIN" -m venv "$VENV_DIR"
    else
      echo "  ğŸ§ª Existing venv found at $VENV_DIR"
    fi

    echo "  ğŸš€ Upgrading pip â€¦"
    source "$VENV_DIR/bin/activate"
    pip install --upgrade pip >/dev/null || echo "âš ï¸  pip upgrade failed in $repo"

    echo "âœ… $repo ready."
    echo
  fi
done

echo "ğŸ All projects are now harmonized using .direnv/python-$PYSHORT"
