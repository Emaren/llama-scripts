#!/usr/bin/env bash
# direnv-bootstrap.sh â€” Elite per-project venv setup
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Usage: ./direnv-bootstrap.sh [project_dir] [--rebuild]

set -euo pipefail

START=$(date +%s)

PROJECT_DIR="${1:-$(pwd)}"
REBUILD="${2:-}"
PYTHON_VERSION="3.13"
PYTHON_FULL_VERSION="3.13.5"
VENV_DIR=".direnv/python-$PYTHON_VERSION"
LOGFILE="$HOME/.venv-bootstrap.log"

cd "$PROJECT_DIR"
PROJECT_NAME="$(basename "$PWD")"
PYTHON_BIN="$(command -v python$PYTHON_VERSION || command -v python3 || true)"

echo -e "\nğŸ”§ Bootstrapping \033[1m$PROJECT_NAME\033[0m in \033[2m$PROJECT_DIR\033[0m"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# ğŸš« Active venv warning
if [[ -n "${VIRTUAL_ENV:-}" ]]; then
  echo "âš ï¸ Active venv detected: $VIRTUAL_ENV â€” consider deactivating first."
fi

# ğŸ” Python Check
if [[ -z "$PYTHON_BIN" || ! -x "$PYTHON_BIN" ]]; then
  echo "âŒ Python $PYTHON_VERSION not found. Try: brew install python@$PYTHON_VERSION"
  exit 1
fi
echo "ğŸ§  Using Python â†’ $PYTHON_BIN"

# ğŸ” Optional Rebuild Logic
if [[ "$REBUILD" == "--rebuild" && -d "$VENV_DIR" ]]; then
  echo "ğŸ§¹ Removing old venv â†’ $VENV_DIR"
  rm -rf "$VENV_DIR"
elif [[ ! -d "$VENV_DIR" ]]; then
  echo "â„¹ï¸  No venv found â€” will create a new one"
else
  echo "â„¹ï¸  Skipping rebuild: venv already exists and no --rebuild flag"
fi

# ğŸ“ .envrc Setup
cat > .envrc <<EOF
# Generated by direnv-bootstrap.sh
export VIRTUAL_ENV="\$PWD/$VENV_DIR"
export PATH="\$VIRTUAL_ENV/bin:\$PATH"
source "\$VIRTUAL_ENV/bin/activate"
EOF
echo "ğŸ“„ Wrote .envrc â†’ $VENV_DIR"

# ğŸ“ .python-version
echo "$PYTHON_FULL_VERSION" > .python-version
echo "ğŸ“Œ Pinned .python-version â†’ $PYTHON_FULL_VERSION"

# ğŸ›‘ .gitignore hygiene
touch .gitignore
ADDED_ENTRIES=()
for LINE in '.envrc' '.direnv/' '.python-version'; do
  if ! grep -qxF "$LINE" .gitignore; then
    echo "$LINE" >> .gitignore
    ADDED_ENTRIES+=("$LINE")
  fi
done
if [[ ${#ADDED_ENTRIES[@]} -gt 0 ]]; then
  echo "ğŸ“˜ Added to .gitignore: ${ADDED_ENTRIES[*]}"
else
  echo "ğŸ“˜ .gitignore already contains required entries"
fi

# ğŸ” Secrets check
[[ -f .env ]] && echo "ğŸ” .env detected (you may want to verify secrets are excluded)"
[[ -f secrets.env ]] && echo "ğŸ” secrets.env detected (you may want to verify secrets are excluded)"

# âœ… direnv allow
direnv allow >/dev/null
echo "âœ… direnv allowed"

# ğŸ Create Venv
if [[ ! -d "$VENV_DIR" ]]; then
  echo "ğŸ Creating venv â†’ $VENV_DIR"
  "$PYTHON_BIN" -m venv "$VENV_DIR"
else
  echo "âœ… Venv already exists â†’ $VENV_DIR"
fi

# â³ Freshness Check
if [[ -f requirements.txt && "$VENV_DIR" -ot requirements.txt ]]; then
  echo -e "âš ï¸  \033[33mStale venv: requirements.txt is newer than $VENV_DIR\033[0m"
else
  echo "âœ… Venv is up to date with requirements.txt"
fi

# ğŸš€ Activate + Upgrade Pip
source "$VENV_DIR/bin/activate"
echo "ğŸš€ Upgrading pip â€¦"
pip install --upgrade pip >/dev/null 2>&1 && echo "âœ… pip upgraded"

# ğŸ“¦ Freeze snapshot
FREEZE_LOG="venv-freeze-$(date +%Y%m%d-%H%M).log"
pip freeze > "$FREEZE_LOG"
echo "ğŸ“¦ Saved pip freeze â†’ $FREEZE_LOG"
echo "ğŸ“„ Top of freeze:"
head -n 5 "$FREEZE_LOG" | sed 's/^/   Â· /'

# ğŸ” Freeze diff
if [[ -f "$FREEZE_LOG.prev" ]]; then
  echo "ğŸ§¬ Changes since last freeze:"
  diff "$FREEZE_LOG.prev" "$FREEZE_LOG" | grep '^[<>]' || echo "No diff."
fi
cp "$FREEZE_LOG" "$FREEZE_LOG.prev"

# ğŸ§ª Smoke Test
echo "ğŸ§ª Running Python health test â€¦"
if python -c 'print("âœ… Python is working")'; then
  echo "ğŸ§ª Test passed"
else
  echo "âŒ Python test failed"
fi

# ğŸ§  Log to ~/.venv-bootstrap.log
{
  echo -e "\nâ–¶ $(date '+%F %T') â€” Bootstrapped $PROJECT_NAME"
  echo "   â€¢ Python:  $(python --version)"
  echo "   â€¢ Venv:    $VENV_DIR"
  echo "   â€¢ Path:    $(which python)"
  echo "   â€¢ Freeze:  $FREEZE_LOG"
} >> "$LOGFILE"

# ğŸ“Š Final Summary
echo -e "\nğŸ“Š \033[1mBootstrap Summary\033[0m"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
printf "Project     â”‚ %-20s\n" "$PROJECT_NAME"
printf "Python      â”‚ %-20s\n" "$(python --version | cut -d' ' -f2)"
printf "Venv Path   â”‚ %-20s\n" "$VENV_DIR"
printf "Python Path â”‚ %-20s\n" "$(which python)"
printf "Freeze File â”‚ %-20s\n" "$FREEZE_LOG"
END=$(date +%s)
echo "â± Total time: $((END - START))s"
echo "âœ… Done"
